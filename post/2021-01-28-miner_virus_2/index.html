<!doctype html>
<html lang="zh-CN">
<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <meta name="referrer" content="no-referrer-when-downgrade">
    

    <title>挖矿病毒2-分析和排查思路 | Anttu&#39;s Blog</title>
    <meta property="og:title" content="挖矿病毒2-分析和排查思路 - Anttu&#39;s Blog">
    <meta property="og:type" content="article">
        
    <meta property="article:published_time" content='2021-01-28T00:29:47&#43;08:00'>
        
        
    <meta property="article:modified_time" content='2021-01-28T00:29:47&#43;08:00'>
        
    <meta name="Keywords" content="golang,go语言,go语言笔记,anttu,java,博客,bash,linux笔记,python笔记,公众号,小程序">
    <meta name="description" content="挖矿病毒2-分析和排查思路">
        
    <meta name="author" content="Anttu">
    <meta property="og:url" content="https://anTtutu.github.io/post/2021-01-28-miner_virus_2/">
    <link rel="shortcut icon" href='/favicon.ico'  type="image/x-icon">

    <link rel="stylesheet" href='/css/normalize.css'>
    <link rel="stylesheet" href='/css/style.css'>
    <script type="text/javascript" src="//cdn.bootcdn.net/ajax/libs/jquery/3.4.1/jquery.min.js"></script>

    
    
    
    
    
    
        <link rel="stylesheet" href='/css/asciinema-player.css'>
    
</head>


<body>
    <header id="header" class="clearfix">
    <div class="container">
        <div class="col-group">
            <div class="site-name ">
                
                    <a id="logo" href="https://anTtutu.github.io/">
                        Anttu&#39;s Blog
                    </a>
                
                <p class="description">一位Java开发者，喜欢研究技术，同时也在学习Golang和Python中，对服务器、Linux使用比较熟悉。欢迎添加技术交流QQ群：655158296</p>
            </div>
            <div>
                <nav id="nav-menu" class="clearfix">
                    <a class="current" href="https://anTtutu.github.io/">首页</a>
                    
                    <a  href="https://anTtutu.github.io/archives/" title="归档">归档</a>
                    
                    <a  href="https://anTtutu.github.io/tags/" title="分类">分类</a>
                    
                    <a  href="https://anTtutu.github.io/about/" title="关于">关于</a>
                    
                </nav>
            </div>
        </div>
    </div>
</header>

    <div id="body">
        <div class="container">
            <div class="col-group">

                <div class="col-8" id="main">
                    
<div class="res-cons">
    <style type="text/css">
    .post-toc {
        position: fixed;
        width: 200px;
        margin-left: -210px;
        padding: 5px 10px;
        font-family: Athelas, STHeiti, Microsoft Yahei, serif;
        font-size: 12px;
        border: 1px solid rgba(0, 0, 0, .07);
        border-radius: 5px;
        background-color: rgba(255, 255, 255, 0.98);
        background-clip: padding-box;
        -webkit-box-shadow: 1px 1px 2px rgba(0, 0, 0, .125);
        box-shadow: 1px 1px 2px rgba(0, 0, 0, .125);
        word-wrap: break-word;
        white-space: nowrap;
        -webkit-box-sizing: border-box;
        box-sizing: border-box;
        z-index: 999;
        cursor: pointer;
        max-height: 70%;
        overflow-y: auto;
        overflow-x: hidden;
    }

    .post-toc .post-toc-title {
        width: 100%;
        margin: 0 auto;
        font-size: 20px;
        font-weight: 400;
        text-transform: uppercase;
        text-align: center;
    }

    .post-toc .post-toc-content {
        font-size: 15px;
    }

    .post-toc .post-toc-content>nav>ul {
        margin: 10px 0;
    }

    .post-toc .post-toc-content ul {
        padding-left: 20px;
        list-style: square;
        margin: 0.5em;
        line-height: 1.8em;
    }

    .post-toc .post-toc-content ul ul {
        padding-left: 15px;
        display: none;
    }

    @media print,
    screen and (max-width:1057px) {
        .post-toc {
            display: none;
        }
    }
</style>
<div class="post-toc" style="position: absolute; top: 188px;">
    <h2 class="post-toc-title">文章目录</h2>
    <div class="post-toc-content">
        <nav id="TableOfContents">
  <ul>
    <li><a href="#1前言">1、前言</a></li>
    <li><a href="#2分析">2、分析</a>
      <ul>
        <li><a href="#21top查看异常进程和占用率">2.1、top查看异常进程和占用率</a></li>
        <li><a href="#22根据pid查找挖矿病毒的目录">2.2、根据pid查找挖矿病毒的目录</a></li>
        <li><a href="#23拿到挖矿主体二进制文件">2.3、拿到挖矿主体二进制文件</a></li>
        <li><a href="#24二进制查看">2.4、二进制查看</a></li>
        <li><a href="#25有能力的可以上ida查看汇编信息">2.5、有能力的可以上ida查看汇编信息</a></li>
        <li><a href="#26查找其他痕迹查看感染来源">2.6、查找其他痕迹，查看感染来源</a></li>
        <li><a href="#27查看日志">2.7、查看日志</a></li>
        <li><a href="#28病毒工具扫描">2.8、病毒工具扫描</a></li>
        <li><a href="#29找守护挖矿的进程">2.9、找守护挖矿的进程</a></li>
      </ul>
    </li>
    <li><a href="#3排查思路">3、排查思路</a>
      <ul>
        <li><a href="#31top异常服务">3.1、top异常服务</a></li>
        <li><a href="#32查看异常进程目录">3.2、查看异常进程目录</a></li>
        <li><a href="#33检查定时任务">3.3、检查定时任务</a></li>
        <li><a href="#34检查账号">3.4、检查账号</a></li>
        <li><a href="#35检查sudo">3.5、检查sudo</a></li>
        <li><a href="#36检查环境变量">3.6、检查环境变量</a></li>
        <li><a href="#37检查执行命令历史记录">3.7、检查执行命令历史记录</a></li>
        <li><a href="#38检查新增的文件或命令">3.8、检查新增的文件或命令</a></li>
        <li><a href="#39针对上一步可以采用修改日期排查法">3.9、针对上一步可以采用修改日期排查法</a></li>
        <li><a href="#310检查异常端口">3.10、检查异常端口</a></li>
        <li><a href="#311检查启动项">3.11、检查启动项</a></li>
        <li><a href="#312检查计划任务">3.12、检查计划任务</a></li>
        <li><a href="#313异常目录">3.13、异常目录</a></li>
        <li><a href="#314检查安装的服务">3.14、检查安装的服务</a></li>
        <li><a href="#315检查日志和分析">3.15、检查日志和分析</a></li>
        <li><a href="#316其他有用的日志">3.16、其他有用的日志</a></li>
        <li><a href="#317检查安装的rpm包或者是否动过手脚">3.17、检查安装的rpm包或者是否动过手脚</a></li>
        <li><a href="#318检查命令的完整性">3.18、检查命令的完整性</a></li>
        <li><a href="#319检查hosts文件">3.19、检查hosts文件</a></li>
        <li><a href="#320检查ssh文件">3.20、检查.ssh文件</a></li>
        <li><a href="#321检查防火墙-iptables">3.21、检查防火墙-iptables</a></li>
        <li><a href="#322检查别名">3.22、检查别名</a></li>
      </ul>
    </li>
    <li><a href="#4加固">4、加固</a>
      <ul>
        <li><a href="#41条件提前做md5sum值">4.1、条件提前做md5sum值</a></li>
        <li><a href="#42增加history的记录条数和详细信息">4.2、增加history的记录条数和详细信息</a></li>
      </ul>
    </li>
    <li><a href="#5挖矿病毒的参考">5、挖矿病毒的参考</a></li>
  </ul>
</nav>
    </div>
</div>
<script type="text/javascript">
    $(document).ready(function () {
        var postToc = $(".post-toc");
        if (postToc.length) {
            var leftPos = $("#main").offset().left;
            if(leftPos<220){
                postToc.css({"width":leftPos-10,"margin-left":(0-leftPos)})
            }

            var t = postToc.offset().top - 20,
                a = {
                    start: {
                        position: "absolute",
                        top: t
                    },
                    process: {
                        position: "fixed",
                        top: 20
                    },
                };
            $(window).scroll(function () {
                var e = $(window).scrollTop();
                e < t ? postToc.css(a.start) : postToc.css(a.process)
            })
        }
    })
</script>
    <article class="post">
        <header>
            <h1 class="post-title">挖矿病毒2-分析和排查思路</h1>
        </header>
        <date class="post-meta meta-date">
            2021年1月28日
        </date>
        
        <div class="post-meta">
            <span>|</span>
            
            <span class="meta-category"><a href='/categories/mine'>mine</a></span>
            
            <span class="meta-category"><a href='/categories/virus'>virus</a></span>
            
            <span class="meta-category"><a href='/categories/linux'>linux</a></span>
            
            <span class="meta-category"><a href='/categories/check'>check</a></span>
            
        </div>
        
        
        <div class="post-meta">
            <span id="busuanzi_container_page_pv">|<span id="busuanzi_value_page_pv"></span><span>
                    阅读</span></span>
        </div>
        
        
        <div class="clear" style="display: none">
            <div class="toc-article">
                <div class="toc-title">文章目录</div>
            </div>
        </div>
        
        <div class="post-content">
            <h2 id="1前言">1、前言</h2>
<p>1月23日晚上22点附近，公司群收到管理员说阿里云报了挖矿病毒的警告<br>
因此本人手里处理过2次挖矿病毒，针对挖矿病毒的杀毒和溯源，个人整理下心得，也有一部分思路来源网络整理</p>
<h2 id="2分析">2、分析</h2>
<h3 id="21top查看异常进程和占用率">2.1、top查看异常进程和占用率</h3>
<p>
        <img class="mx-auto" alt="" src="/posts/virus/top2.png" />   
    
发现一个叫sh的进程名几乎占用全部的cpu资源</p>
<h3 id="22根据pid查找挖矿病毒的目录">2.2、根据pid查找挖矿病毒的目录</h3>
<p>当然用其他方法也可以找出，这里是当挖矿病毒正在运行时这么查找更加容易

        <img class="mx-auto" alt="" src="/posts/virus/proc.png" />   
    
找到挖矿病毒的主体文件所在目录了/tmp/admin/sh</p>
<p>不过通常病毒文件会用隐藏目录，因此进入/tmp后需要用ls -lart查看隐藏目录<br>
最后锁定挖矿病毒主题文件.sh，其他文件经过分析，属于创建的脚本，用于给挖矿病毒主题创造有利的环境<br>

        <img class="mx-auto" alt="" src="/posts/virus/dir.png" />   
    
大多数厉害的挖矿病毒是不会留下脚本的，需要自己根据蛛丝马迹找，能找到脚本可以把修改的地方针对性的还原，没法找到脚本就没法100%还原被修改的配置了</p>
<h3 id="23拿到挖矿主体二进制文件">2.3、拿到挖矿主体二进制文件</h3>
<p>查看是否加壳，用PEiD.0.95查看

        <img class="mx-auto" alt="" src="/posts/virus/PE.png" />   
    
目前抓住的这个没有加壳，上一次的有加壳

        <img class="mx-auto" alt="" src="/posts/virus/PE_info.png" />   
    
不过查看加壳与否我都没法脱壳的，只是用工具查看是否还有价值的信息，加了强壳的二进制查看的价值不大了</p>
<h3 id="24二进制查看">2.4、二进制查看</h3>
<p>尝试是否能找到一点有用的信息<br>
比如这个没加壳的就容易看到一些有价值的信息

        <img class="mx-auto" alt="" src="/posts/virus/byte.png" />   
    </p>
<h3 id="25有能力的可以上ida查看汇编信息">2.5、有能力的可以上ida查看汇编信息</h3>
<p>本人不才。。。只能看个图
不管是汇编视图还是二进制视图，因个人能力不足，无法查看更多有价值的信息

        <img class="mx-auto" alt="" src="/posts/virus/ida1.png" />   
    

        <img class="mx-auto" alt="" src="/posts/virus/ida2.png" />   
    </p>
<h3 id="26查找其他痕迹查看感染来源">2.6、查找其他痕迹，查看感染来源</h3>
<p>
        <img class="mx-auto" alt="" src="/posts/virus/last.png" />   
    </p>
<h3 id="27查看日志">2.7、查看日志</h3>
<p>
        <img class="mx-auto" alt="" src="/posts/virus/message.png" />   
    </p>
<h3 id="28病毒工具扫描">2.8、病毒工具扫描</h3>
<p>
        <img class="mx-auto" alt="" src="/posts/virus/warn1.png" />   
    

        <img class="mx-auto" alt="" src="/posts/virus/warn2.png" />   
    </p>
<h3 id="29找守护挖矿的进程">2.9、找守护挖矿的进程</h3>
<p>可能是定时任务，也可能是其他二进制脚本

        <img class="mx-auto" alt="" src="/posts/virus/kinsing.png" />   
    </p>
<h2 id="3排查思路">3、排查思路</h2>
<p>先找到病毒主体文件，然后需要有清晰的排查思路，结合搜集到的信息，可以去一些安全或者漏洞网站查询是否有人中招和排查经验，结合已经曝光的信息再加上自己的思路，可以事半功倍</p>
<h3 id="31top异常服务">3.1、top异常服务</h3>
<p>有的挖矿病毒不会修改服务名，有的会隐藏成sysupdate、networkservice、sysguard这些看着像系统进程的名称，有的还会改成apache、php、mysql等服务名，需要凭职业经验分辨</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">top
top &gt; top.txt
vi top.txt
</code></pre></td></tr></table>
</div>
</div><h3 id="32查看异常进程目录">3.2、查看异常进程目录</h3>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">ps -axuf | grep pid
ls /proc/<span style="color:#000;font-weight:bold">{</span><span style="color:#008080">$pid</span><span style="color:#000;font-weight:bold">}</span>/
</code></pre></td></tr></table>
</div>
</div><h3 id="33检查定时任务">3.3、检查定时任务</h3>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">/etc/crontab
/var/spool/cron/root
</code></pre></td></tr></table>
</div>
</div><p>有修改的话需要还原</p>
<h3 id="34检查账号">3.4、检查账号</h3>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">/etc/passwd
/etc/shadow
</code></pre></td></tr></table>
</div>
</div><p>有新增异常账号需要删除,需要留意特权账号uid=0的</p>
<h3 id="35检查sudo">3.5、检查sudo</h3>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">/etc/sudoers
</code></pre></td></tr></table>
</div>
</div><p>有新增的异常命令或者账号需要清理</p>
<h3 id="36检查环境变量">3.6、检查环境变量</h3>
<p>root账号的环境变量文件</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">~/.bash_profile
~/.bashrc
~/.cshrc
~/.tcshrc
~/.profile
/etc/profile
<span style="color:#0086b3">echo</span> <span style="color:#008080">$PATH</span>
</code></pre></td></tr></table>
</div>
</div><p>有新增的话需要清理</p>
<p>其他业务账号的环境变量文件需要挨个检查下，因为已经发现本次是admin账号感染，这里就主要排查admin账号</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">/<span style="color:#008080">$HOME</span>/.bash_profile
/<span style="color:#008080">$HOME</span>/.bashrc
/<span style="color:#008080">$HOME</span>/.cshrc
/<span style="color:#008080">$HOME</span>/.tcshrc
/<span style="color:#008080">$HOME</span>/.profile
<span style="color:#0086b3">echo</span> <span style="color:#008080">$PATH</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="37检查执行命令历史记录">3.7、检查执行命令历史记录</h3>
<p>大多数厉害的挖矿病毒会清理history -c，因此抱着试试看的想法还是检查下</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">.bash_history
</code></pre></td></tr></table>
</div>
</div><p>如果服务器上还有其他服务，比如mysql redis mongodb等也需要排查下，比如勒索病毒就好这口</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">.rediscli_history
.mysql_history
.dbshell
</code></pre></td></tr></table>
</div>
</div><h3 id="38检查新增的文件或命令">3.8、检查新增的文件或命令</h3>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">ls -lart /bin
ls -lart /sbin
ls -lart /usr/bin/
ls -lart /usr/sbin/
ls -lart /tmp
ls -lart /etc/init.d/
</code></pre></td></tr></table>
</div>
</div><h3 id="39针对上一步可以采用修改日期排查法">3.9、针对上一步可以采用修改日期排查法</h3>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#998;font-style:italic"># 查找777权限的文件</span>
find . -name * -perm <span style="color:#099">777</span>
<span style="color:#998;font-style:italic"># 按日期查找</span>
find . -type f -newermt 2020-09-24 -ls
<span style="color:#998;font-style:italic"># 按时间范围查找</span>
find . -newermt <span style="color:#d14">&#34;2019-09-09 00:00:00&#34;</span> -not -newermt <span style="color:#d14">&#34;2019-09-10 00:00:00+1&#34;</span>  
</code></pre></td></tr></table>
</div>
</div><h3 id="310检查异常端口">3.10、检查异常端口</h3>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">netstat -antlp|more
arp -a
lsof -i
</code></pre></td></tr></table>
</div>
</div><h3 id="311检查启动项">3.11、检查启动项</h3>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">vi  /etc/inittab
<span style="color:#008080">id</span><span style="color:#000;font-weight:bold">=</span>3：initdefault  <span style="color:#998;font-style:italic">#系统开机后直接进入哪个运行级别</span>

more /etc/rc.local 

<span style="color:#998;font-style:italic"># /etc/rc.d/rc[0~6].d </span>
ls -lart /etc/rc.d/rc0.d/
ls -lart /etc/rc.d/rc1.d/
ls -lart /etc/rc.d/rc2.d/
ls -lart /etc/rc.d/rc3.d/
ls -lart /etc/rc.d/rc4.d/
ls -lart /etc/rc.d/rc5.d/
ls -lart /etc/rc.d/rc6.d/

ls -lart /etc/rc.d/init.d/
</code></pre></td></tr></table>
</div>
</div><p>清理异常启动项</p>
<h3 id="312检查计划任务">3.12、检查计划任务</h3>
<p>一般会隐藏</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">crontab -l
ls /etc/cron*
/etc/crontab
/var/spool/cron/root
/etc/anacrontab
/var/spool/anacron/*
</code></pre></td></tr></table>
</div>
</div><p>清理和还原定时任务</p>
<h3 id="313异常目录">3.13、异常目录</h3>
<p>挖矿一般喜欢用.隐藏目录或者/tmp下</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">ls -lart /tmp | more
ls -lart ~ | more
ls -lart <span style="color:#008080">$HOME</span> | more
</code></pre></td></tr></table>
</div>
</div><h3 id="314检查安装的服务">3.14、检查安装的服务</h3>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">chkconfig  --list | more
<span style="color:#998;font-style:italic"># 中文环境</span>
chkconfig --list | grep <span style="color:#d14">&#34;3:启用\|5:启用&#34;</span>
<span style="color:#998;font-style:italic"># 英文环境</span>
chkconfig --list | grep <span style="color:#d14">&#34;3:on\|5:on&#34;</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="315检查日志和分析">3.15、检查日志和分析</h3>
<p>系统日志 日志默认存放位置：/var/log/</p>
<p>查看日志配置情况：more /etc/rsyslog.conf</p>
<table>
<thead>
<tr>
<th>日志文件</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>/var/log/cron</td>
<td>记录了系统定时任务相关的日志</td>
</tr>
<tr>
<td>/var/log/cups</td>
<td>记录打印信息的日志</td>
</tr>
<tr>
<td>/var/log/dmesg</td>
<td>记录了系统在开机时内核自检的信息，也可以使用dmesg命令直接查看内核自检信息</td>
</tr>
<tr>
<td>/var/log/mailog</td>
<td>记录邮件信息</td>
</tr>
<tr>
<td>/var/log/message</td>
<td>记录系统重要信息的日志。这个日志文件中会记录Linux系统的绝大多数重要信息，如果系统出现问题时，首先要检查的就应该是这个日志文件</td>
</tr>
<tr>
<td>/var/log/btmp</td>
<td>记录错误登录日志，这个文件是二进制文件，不能直接vi查看，而要使用lastb命令查看</td>
</tr>
<tr>
<td>/var/log/lastlog</td>
<td>记录系统中所有用户最后一次登录时间的日志，这个文件是二进制文件，不能直接vi，而要使用lastlog命令查看</td>
</tr>
<tr>
<td>/var/log/wtmp</td>
<td>永久记录所有用户的登录、注销信息，同时记录系统的启动、重启、关机事件。同样这个文件也是一个二进制文件，不能直接vi，而需要使用last命令来查看</td>
</tr>
<tr>
<td>/var/log/utmp</td>
<td>记录当前已经登录的用户信息，这个文件会随着用户的登录和注销不断变化，只记录当前登录用户的信息。同样这个文件不能直接vi，而要使用w,who,users等命令来查询</td>
</tr>
<tr>
<td>/var/log/secure</td>
<td>记录验证和授权方面的信息，只要涉及账号和密码的程序都会记录，比如SSH登录，su切换用户，sudo授权，甚至添加用户和修改用户密码都会记录在这个日志文件中</td>
</tr>
</tbody>
</table>
<h3 id="316其他有用的日志">3.16、其他有用的日志</h3>
<p>apt-get安装日志</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">gedit /var/log/apt/term.log
cat /var/log/apt/history.log | more
/var/log/dpkg.log
</code></pre></td></tr></table>
</div>
</div><p>yum安装日志和历史信息</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#998;font-style:italic"># 查看yum安装软件日志的方法</span>
/var/log/yum.log
<span style="color:#998;font-style:italic"># 查看yum使用的历史记录的方法</span>
yum <span style="color:#0086b3">history</span> info
</code></pre></td></tr></table>
</div>
</div><h3 id="317检查安装的rpm包或者是否动过手脚">3.17、检查安装的rpm包或者是否动过手脚</h3>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#000;font-weight:bold">[</span>root@docker-test ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># rpm -Va</span>
....L....  c /etc/pam.d/fingerprint-auth
....L....  c /etc/pam.d/password-auth
....L....  c /etc/pam.d/postlogin
....L....  c /etc/pam.d/smartcard-auth
....L....  c /etc/pam.d/system-auth
.M.......  g /var/log/dmesg
.M.......  g /var/log/dmesg.old
.......T.  c /etc/selinux/targeted/contexts/customizable_types
S.5....T.  c /etc/sysconfig/authconfig
.M.......  g /etc/pki/ca-trust/extracted/java/cacerts
.M.......  g /etc/pki/ca-trust/extracted/openssl/ca-bundle.trust.crt
.M.......  g /etc/pki/ca-trust/extracted/pem/email-ca-bundle.pem
.M.......  g /etc/pki/ca-trust/extracted/pem/objsign-ca-bundle.pem
.M.......  g /etc/pki/ca-trust/extracted/pem/tls-ca-bundle.pem
.M.......  g /boot/initramfs-3.10.0-957.el7.x86_64.img
</code></pre></td></tr></table>
</div>
</div><p>说明：
参数|含义
-|-
S|表示文件长度发生了变化
M|表示文件的访问权限或文件类型发生了变化
5|表示MD5校验和发生了变化
D|表示设备节点的属性发生了变化
L|表示文件的符号链接发生了变化
U|表示文件/子目录/ 设备节点的owner 发生了变化
G|表示文件/子目录/ 设备节点的group 发生了变化
T|表示文件最后一次的修改时间是发生了变化</p>
<h3 id="318检查命令的完整性">3.18、检查命令的完整性</h3>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">rpm -qf /bin/ls
</code></pre></td></tr></table>
</div>
</div><h3 id="319检查hosts文件">3.19、检查hosts文件</h3>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">/etc/hosts
</code></pre></td></tr></table>
</div>
</div><p>清理异常的映射地址</p>
<h3 id="320检查ssh文件">3.20、检查.ssh文件</h3>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">ls -lart ~/.ssh
ls -lart <span style="color:#008080">$HOME</span>/.ssh
</code></pre></td></tr></table>
</div>
</div><p>清理异常的pub key和ssh信任</p>
<h3 id="321检查防火墙-iptables">3.21、检查防火墙-iptables</h3>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">iptables --list
<span style="color:#998;font-style:italic"># centos</span>
cat /etc/sysconfig/iptables-config
<span style="color:#998;font-style:italic"># ubuntu没有具体的规则文件，保存在内存中</span>
</code></pre></td></tr></table>
</div>
</div><p>清理异常的规则</p>
<h3 id="322检查别名">3.22、检查别名</h3>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#0086b3">alias</span>
</code></pre></td></tr></table>
</div>
</div><p>清理异常的别名</p>
<h2 id="4加固">4、加固</h2>
<p>这里列举下部分比较容易的加固方式</p>
<h3 id="41条件提前做md5sum值">4.1、条件提前做md5sum值</h3>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">find / -user root -perm -2000 -print | xargs md5sum &gt; 1.log
find / -user root -perm -4000 -print | xargs md5sum &gt; 2.log
</code></pre></td></tr></table>
</div>
</div><p>提前把关键文件的md5值搜集，后续可以比对</p>
<h3 id="42增加history的记录条数和详细信息">4.2、增加history的记录条数和详细信息</h3>
<p>保存1W条history</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#008080">HISTFILESIZE</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">2000</span> <span style="color:#998;font-style:italic">#设置保存历史命令的文件大小</span>
<span style="color:#008080">HISTSIZE</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">10000</span>    <span style="color:#998;font-style:italic">#保存历史命令条数</span>
</code></pre></td></tr></table>
</div>
</div><p>history记录详细信息</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#998;font-style:italic">###### 加固历史命令显示 #########</span>
<span style="color:#008080">USER_IP</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">`</span>who -u am i 2&gt;/dev/null | awk <span style="color:#d14">&#39;{print $NF}&#39;</span> | sed -e <span style="color:#d14">&#39;s/[()]//g&#39;</span><span style="color:#d14">`</span>
<span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">[</span> <span style="color:#d14">&#34;</span><span style="color:#008080">$USER_IP</span><span style="color:#d14">&#34;</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#34;&#34;</span> <span style="color:#000;font-weight:bold">]</span>
<span style="color:#000;font-weight:bold">then</span>
<span style="color:#008080">USER_IP</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">`</span>hostname<span style="color:#d14">`</span>
<span style="color:#000;font-weight:bold">fi</span>
<span style="color:#0086b3">export</span> <span style="color:#008080">HISTTIMEFORMAT</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#34;%F %T </span><span style="color:#008080">$USER_IP</span><span style="color:#d14"> `whoami` &#34;</span>
<span style="color:#0086b3">shopt</span> -s histappend
<span style="color:#0086b3">export</span> <span style="color:#008080">PROMPT_COMMAND</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#34;history -a&#34;</span>
<span style="color:#998;font-style:italic">###### 加固历史命令显示 #########</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="5挖矿病毒的参考">5、挖矿病毒的参考</h2>
<p>因为我发觉的2次挖矿病毒跟下面的表现很想，可能是变种了，有些环节不一样<br>
kinsing: <a href="https://blog.trendmicro.com.tw/?p=66511">https://blog.trendmicro.com.tw/?p=66511</a><br>
kinsing: <a href="https://blog.csdn.net/cfm_gavin/article/details/103803448">https://blog.csdn.net/cfm_gavin/article/details/103803448</a><br>
sh: <a href="https://notes.daiyuhe.com/clear-linux-mining-virus/">https://notes.daiyuhe.com/clear-linux-mining-virus/</a><br>
sh: <a href="https://blog.csdn.net/jabyn/article/details/111239735">https://blog.csdn.net/jabyn/article/details/111239735</a><br>
xr: <a href="https://www.freebuf.com/column/240100.html">https://www.freebuf.com/column/240100.html</a></p>

        </div>

        
<div class="post-archive">
    <ul class="post-copyright">
        <li><strong>原文作者：</strong><a rel="author" href="https://anTtutu.github.io/">Anttu</a></li>
        <li style="word-break:break-all"><strong>原文链接：</strong><a href="https://anTtutu.github.io/post/2021-01-28-miner_virus_2/">https://anTtutu.github.io/post/2021-01-28-miner_virus_2/</a></li>
        <li><strong>版权声明：</strong>本作品采用<a rel="license" href="https://creativecommons.org/licenses/by-nc-nd/4.0/">知识共享署名-非商业性使用-禁止演绎 4.0 国际许可协议</a>进行许可，非商业转载请注明出处（作者，原文链接），商业转载请联系作者获得授权。</li>
    </ul>
</div>
<br/>



        

<div class="post-archive">
    <h2>See Also</h2>
    <ul class="listing">
        
        <li><a href="/post/2020-08-19-mine_virus/">分析挖矿病毒</a></li>
        
        <li><a href="/post/2020-09-17-xWindows_x11_xQuartz/">Mac下远程运行Linux的GUI程序</a></li>
        
        <li><a href="/post/2020-09-10-asciinema_local_test/">linux下录屏工具本地化测试</a></li>
        
        <li><a href="/post/2017-07-15-kali/">初识Kali-linux及其工具</a></li>
        
        <li><a href="/post/2021-01-16-goland_strange-knowledge/">golang奇怪的知识点</a></li>
        
    </ul>
</div>


        <div class="post-meta meta-tags">
            
            <ul class="clearfix">
                
                <li><a href='/tags/mine'>mine</a></li>
                
                <li><a href='/tags/virus'>virus</a></li>
                
                <li><a href='/tags/linux'>linux</a></li>
                
                <li><a href='/tags/check'>check</a></li>
                
            </ul>
            
        </div>
    </article>
    
    

    
    
    <div class="post bg-white">
      <script src="https://utteranc.es/client.js"
            repo= "anTtutu/anTtutu.github.io"
            issue-term="pathname"
            theme="github-light"
            crossorigin="anonymous"
            async>
      </script>
    </div>
    
</div>

                    <footer id="footer">
    <div>
        &copy; 2021 <a href="https://anTtutu.github.io/">Anttu&#39;s Blog By Anttu</a>
        
    </div>
    <br />
    <div>
        <div class="github-badge">
            <a href="https://gohugo.io/" target="_black" rel="nofollow"><span class="badge-subject">Powered by</span><span class="badge-value bg-blue">Hugo</span></a>
        </div>
        
        <div class="github-badge">
            <a href="https://github.com/flysnow-org/maupassant-hugo" target="_black"><span class="badge-subject">Theme</span><span class="badge-value bg-yellowgreen">Maupassant</span></a>
        </div>
    </div>
</footer>


    
    <script type="text/javascript">
        window.MathJax = {
            tex2jax: {
                inlineMath: [['$', '$']],
                processEscapes: true
                }
            };
    </script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML' async></script>

<a id="rocket" href="#top"></a>
<script type="text/javascript" src='/js/totop.js?v=0.0.0' async=""></script>



    <script type="text/javascript" src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script>




    <script src='/js/asciinema-player.js'></script>

                </div>

                <div id="secondary">
    <section class="widget">
        <form id="search" action='https://anTtutu.github.io/search/' method="get" accept-charset="utf-8" target="_blank" _lpchecked="1">
      
      <input type="text" name="q" maxlength="20" placeholder="Search">
      <input type="hidden" name="sitesearch" value="https://anTtutu.github.io/">
      <button type="submit" class="submit icon-search"></button>
</form>
    </section>
    
    <section class="widget">
        <h3 class="widget-title">最近文章</h3>
<ul class="widget-list">
    
    <li>
        <a href="https://anTtutu.github.io/post/2021-01-28-miner_virus_2/" title="挖矿病毒2-分析和排查思路">挖矿病毒2-分析和排查思路</a>
    </li>
    
    <li>
        <a href="https://anTtutu.github.io/post/2021-01-16-goland_strange-knowledge/" title="golang奇怪的知识点">golang奇怪的知识点</a>
    </li>
    
    <li>
        <a href="https://anTtutu.github.io/post/2020-12-26-win10_go_build_icon/" title="Win10下打包go工具增加icon">Win10下打包go工具增加icon</a>
    </li>
    
    <li>
        <a href="https://anTtutu.github.io/post/2020-12-05-win10_gcc_build_tools/" title="Win10下新的gcc工具">Win10下新的gcc工具</a>
    </li>
    
    <li>
        <a href="https://anTtutu.github.io/post/2020-11-16-ynote_disable_ad/" title="Win10有道云笔记去掉左下角广告">Win10有道云笔记去掉左下角广告</a>
    </li>
    
    <li>
        <a href="https://anTtutu.github.io/post/2020-11-15-win10_kenlm_install/" title="Win10安装kenlm语言模型模块">Win10安装kenlm语言模型模块</a>
    </li>
    
    <li>
        <a href="https://anTtutu.github.io/post/2020-10-08-mbp_ssd/" title="Mac升级SSD">Mac升级SSD</a>
    </li>
    
    <li>
        <a href="https://anTtutu.github.io/post/2020-09-28-android_termux/" title="android下安装termux模拟器-超便携linux">android下安装termux模拟器-超便携linux</a>
    </li>
    
    <li>
        <a href="https://anTtutu.github.io/post/2020-09-21-mac_app_list/" title="Mac下的工具软件">Mac下的工具软件</a>
    </li>
    
    <li>
        <a href="https://anTtutu.github.io/post/2020-09-20-mac_aria2_install/" title="Mac下安装aria2下载工具">Mac下安装aria2下载工具</a>
    </li>
    
</ul>
    </section>

    

    <section class="widget">
        <h3 class="widget-title"><a href='/categories/'>分类</a></h3>
<ul class="widget-list">
    
    <li><a href="https://anTtutu.github.io/categories/JDK%E7%9A%84bug/">JDK的bug (1)</a></li>
    
    <li><a href="https://anTtutu.github.io/categories/Mac/">Mac (4)</a></li>
    
    <li><a href="https://anTtutu.github.io/categories/OrangePi/">OrangePi (1)</a></li>
    
    <li><a href="https://anTtutu.github.io/categories/SSD/">SSD (1)</a></li>
    
    <li><a href="https://anTtutu.github.io/categories/Win10/">Win10 (4)</a></li>
    
    <li><a href="https://anTtutu.github.io/categories/about/">about (1)</a></li>
    
    <li><a href="https://anTtutu.github.io/categories/android/">android (1)</a></li>
    
    <li><a href="https://anTtutu.github.io/categories/app/">app (1)</a></li>
    
    <li><a href="https://anTtutu.github.io/categories/aria2/">aria2 (1)</a></li>
    
    <li><a href="https://anTtutu.github.io/categories/blog/">blog (2)</a></li>
    
    <li><a href="https://anTtutu.github.io/categories/build/">build (1)</a></li>
    
    <li><a href="https://anTtutu.github.io/categories/check/">check (1)</a></li>
    
    <li><a href="https://anTtutu.github.io/categories/cygwin/">cygwin (1)</a></li>
    
    <li><a href="https://anTtutu.github.io/categories/gcc/">gcc (1)</a></li>
    
    <li><a href="https://anTtutu.github.io/categories/gitment/">gitment (1)</a></li>
    
    <li><a href="https://anTtutu.github.io/categories/golang/">golang (2)</a></li>
    
    <li><a href="https://anTtutu.github.io/categories/h2/">h2 (1)</a></li>
    
    <li><a href="https://anTtutu.github.io/categories/hugo/">hugo (1)</a></li>
    
    <li><a href="https://anTtutu.github.io/categories/java/">java (5)</a></li>
    
    <li><a href="https://anTtutu.github.io/categories/jekyll/">jekyll (1)</a></li>
    
    <li><a href="https://anTtutu.github.io/categories/js/">js (1)</a></li>
    
    <li><a href="https://anTtutu.github.io/categories/kenlm/">kenlm (1)</a></li>
    
    <li><a href="https://anTtutu.github.io/categories/linux/">linux (5)</a></li>
    
    <li><a href="https://anTtutu.github.io/categories/log4j/">log4j (1)</a></li>
    
    <li><a href="https://anTtutu.github.io/categories/mine/">mine (1)</a></li>
    
    <li><a href="https://anTtutu.github.io/categories/mysql/">mysql (2)</a></li>
    
    <li><a href="https://anTtutu.github.io/categories/oracle/">oracle (3)</a></li>
    
    <li><a href="https://anTtutu.github.io/categories/python/">python (1)</a></li>
    
    <li><a href="https://anTtutu.github.io/categories/rec/">rec (1)</a></li>
    
    <li><a href="https://anTtutu.github.io/categories/redis/">redis (2)</a></li>
    
    <li><a href="https://anTtutu.github.io/categories/shell/">shell (2)</a></li>
    
    <li><a href="https://anTtutu.github.io/categories/sqlmap/">sqlmap (1)</a></li>
    
    <li><a href="https://anTtutu.github.io/categories/termux/">termux (1)</a></li>
    
    <li><a href="https://anTtutu.github.io/categories/vcs/">vcs (7)</a></li>
    
    <li><a href="https://anTtutu.github.io/categories/virus/">virus (2)</a></li>
    
    <li><a href="https://anTtutu.github.io/categories/ynote/">ynote (1)</a></li>
    
</ul>
    </section>

    <section class="widget">
        <h3 class="widget-title"><a href='/tags/'>标签</a></h3>
<div class="tagcloud">
    
    <a href="https://anTtutu.github.io/tags/JDK%E7%9A%84bug/">JDK的bug</a>
    
    <a href="https://anTtutu.github.io/tags/Mac/">Mac</a>
    
    <a href="https://anTtutu.github.io/tags/OrangePi/">OrangePi</a>
    
    <a href="https://anTtutu.github.io/tags/SSD/">SSD</a>
    
    <a href="https://anTtutu.github.io/tags/Win10/">Win10</a>
    
    <a href="https://anTtutu.github.io/tags/about/">about</a>
    
    <a href="https://anTtutu.github.io/tags/android/">android</a>
    
    <a href="https://anTtutu.github.io/tags/app/">app</a>
    
    <a href="https://anTtutu.github.io/tags/aria2/">aria2</a>
    
    <a href="https://anTtutu.github.io/tags/blog/">blog</a>
    
    <a href="https://anTtutu.github.io/tags/build/">build</a>
    
    <a href="https://anTtutu.github.io/tags/check/">check</a>
    
    <a href="https://anTtutu.github.io/tags/cygwin/">cygwin</a>
    
    <a href="https://anTtutu.github.io/tags/gcc/">gcc</a>
    
    <a href="https://anTtutu.github.io/tags/gitment/">gitment</a>
    
    <a href="https://anTtutu.github.io/tags/golang/">golang</a>
    
    <a href="https://anTtutu.github.io/tags/h2/">h2</a>
    
    <a href="https://anTtutu.github.io/tags/hugo/">hugo</a>
    
    <a href="https://anTtutu.github.io/tags/java/">java</a>
    
    <a href="https://anTtutu.github.io/tags/jekyll/">jekyll</a>
    
    <a href="https://anTtutu.github.io/tags/js/">js</a>
    
    <a href="https://anTtutu.github.io/tags/kenlm/">kenlm</a>
    
    <a href="https://anTtutu.github.io/tags/linux/">linux</a>
    
    <a href="https://anTtutu.github.io/tags/log4j/">log4j</a>
    
    <a href="https://anTtutu.github.io/tags/mine/">mine</a>
    
    <a href="https://anTtutu.github.io/tags/mysql/">mysql</a>
    
    <a href="https://anTtutu.github.io/tags/oracle/">oracle</a>
    
    <a href="https://anTtutu.github.io/tags/python/">python</a>
    
    <a href="https://anTtutu.github.io/tags/rec/">rec</a>
    
    <a href="https://anTtutu.github.io/tags/redis/">redis</a>
    
    <a href="https://anTtutu.github.io/tags/shell/">shell</a>
    
    <a href="https://anTtutu.github.io/tags/sqlmap/">sqlmap</a>
    
    <a href="https://anTtutu.github.io/tags/termux/">termux</a>
    
    <a href="https://anTtutu.github.io/tags/vcs/">vcs</a>
    
    <a href="https://anTtutu.github.io/tags/virus/">virus</a>
    
    <a href="https://anTtutu.github.io/tags/ynote/">ynote</a>
    
</div>
    </section>

    

    <section class="widget">
        <h3 class="widget-title">其它</h3>
        <ul class="widget-list">
            <li><a href="https://anTtutu.github.io/index.xml">文章 RSS</a></li>
        </ul>
    </section>
</div>
            </div>
        </div>
    </div>
</body>

</html>